<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Register device — Secure Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:Inter,Arial;padding:16px}
    #status{margin-bottom:10px;color:#222}
    pre#debug{background:#f7f7f8;border:1px solid #ddd;padding:10px;max-height:300px;overflow:auto}
  </style>
</head>
<body>
  <h2>Registering device...</h2>
  <div id="status">Starting...</div>
  <pre id="debug">Logs:\n</pre>

<script>
/* CONFIG */
const SUPA_URL = 'https://dvjihjkyenzkacviywgk.supabase.co'; // replace if different
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2amloamt5ZW56a2Fjdml5d2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMzQ0MTgsImV4cCI6MjA2MzgxMDQxOH0.1Hl9Cb-rTbHKDSlnn2tM-6trzOySigUg6Be0xVG2URg'; // <-- replace
const EDGE_REGISTER_FN = 'register-user'; // edge function name you deployed
const supa = supabase.createClient(SUPA_URL, SUPA_ANON);

const statusEl = document.getElementById('status'), dbg = document.getElementById('debug');
function log(...a){ dbg.textContent += a.join(' ') + '\n'; dbg.scrollTop = dbg.scrollHeight; console.log(...a) }

/* HELPERS */
function urlHasToken(){
  const h = window.location.hash || '';
  const s = window.location.search || '';
  return h.includes('access_token') || s.includes('access_token') || s.includes('refresh_token') || h.includes('refresh_token');
}
function clearUrlTokens(){
  try{ history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/(access_token=.*?(&|$))|(refresh_token=.*?(&|$))/g,'')); }catch(e){ log('clearUrlTokens error',e) }
}
async function sha256Fingerprint(){
  try{
    const parts = [
      navigator.userAgent||'', navigator.language||'',
      screen.width||'', screen.height||'', screen.colorDepth||'',
      new Date().getTimezoneOffset(), window.devicePixelRatio||'',
      navigator.hardwareConcurrency||'', navigator.platform||''
    ];
    const raw = parts.join('::');
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(raw));
    const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    return 'sha2_' + hex;
  }catch(e){ return 'fallback_' + Math.random().toString(36).slice(2,9) }
}
async function callRegisterFn(payload){
  const projectRef = SUPA_URL.split('://')[1].split('.supabase.co')[0];
  const fnUrl = `https://${projectRef}.functions.supabase.co/${EDGE_REGISTER_FN}`;
  log('Calling', fnUrl);
  log('Payload', payload);
  const res = await fetch(fnUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  let json; try{ json = await res.json(); }catch(e){ json = { error:'invalid-json' } }
  return { ok: res.ok, status: res.status, body: json };
}

/* MAIN */
async function run(){
  try{
    statusEl.textContent = 'Handling auth tokens...'; log('run start');
    if(urlHasToken()){
      try{
        const sessionFromUrl = await supa.auth.getSessionFromUrl({ storeSession: true }).catch(e=>{ throw e });
        log('getSessionFromUrl result', sessionFromUrl);
      }catch(e){
        // sometimes throws empty object — log & continue
        log('getSessionFromUrl threw', e);
      }
      clearUrlTokens();
    } else log('No token in URL');

    statusEl.textContent = 'Reading user...';
    const { data: userData, error: userErr } = await supa.auth.getUser().catch(e=>({ error:e }));
    if(userErr) log('getUser error', userErr);
    const user = userData && userData.user ? userData.user : null;
    if(!user){
      statusEl.textContent = 'Waiting for sign-in...';
      log('No user found immediately — listening for SIGNED_IN for 6s');
      let done = false;
      const timeout = setTimeout(()=>{ if(!done){ log('auth wait timed out'); statusEl.textContent='Not signed in. Redirecting to login...'; setTimeout(()=>location.href='/sln/login.html',800) } }, 6000);
      supa.auth.onAuthStateChange((event, session)=>{ log('auth event', event); if(event==='SIGNED_IN' && session && !done){ done=true; clearTimeout(timeout); doRegister(session.user) }});
      return;
    }
    // user exists
    doRegister(user);
  }catch(e){ log('run exception', e); statusEl.textContent='Error. See debug.' }
}

async function doRegister(user){
  try{
    statusEl.textContent = 'Fingerprinting...'; log('User:', user.email);
    // try to get fingerprint using SHA fallback (reliable)
    const deviceHash = await sha256Fingerprint();
    log('Device hash', deviceHash);

    statusEl.textContent = 'Calling server...';
    const payload = { email: user.email, name: (user.user_metadata && (user.user_metadata.full_name||user.user_metadata.name))||user.email, deviceHash };
    const res = await callRegisterFn(payload);
    log('Server response', res);

    if(res.ok && (res.body.status === 'registered' || res.body.status === 'authorized')){
      statusEl.textContent = 'Registered — redirecting to chat...';
      setTimeout(()=>location.href='/sln_chat_interface.html',900);
    } else if(res.body && res.body.status === 'unauthorized'){
      statusEl.textContent = 'Access denied: unauthorized device';
      log('unauthorized', res.body);
    } else {
      statusEl.textContent = 'Server error. See debug below.';
      log('unexpected server result', res);
    }
  }catch(e){ log('doRegister exception', e); statusEl.textContent='Error during registration. See debug.' }
}

window.addEventListener('DOMContentLoaded', run);
</script>
</body>
</html>